import { ReactNode } from 'react';
import GlossaryTerm from '../components/Glossary/GlossaryTerm';

export interface StudentCase {
  id: string;
  createdAt: Date;
  studentName?: string;
  title: string;
  category: CaseCategory;
  challenge: {
    context: string;
    problem: string;
    impact: string;
  };
  solution: {
    approach: string;
    tools: string[];
    implementation: string;
  };
  results: {
    measurableROI: string;
    timeGains: string;
    otherBenefits: string[];
  };
  dafPerspective: {
    concerns: string[];
    questions: string[];
  };
}

export type CaseCategory =
  | 'automation'
  | 'reporting'
  | 'collaboration'
  | 'financial'
  | 'hr-payroll'
  | 'data-analytics'
  | 'compliance'
  | 'process';

export interface CaseTemplate {
  id: CaseCategory;
  name: string;
  description: string;
  icon: string;
  color: string;
  examples: {
    challenge: string[];
    solutions: string[];
    benefits: string[];
  };
  dafConcerns: string[];
  typicalROI: string[];
}

export const CASE_TEMPLATES: CaseTemplate[] = [
  {
    id: 'automation',
    name: 'Automatisation IA/RPA',
    description: 'Automatiser des t√¢ches r√©p√©titives avec l\'IA ou des robots',
    icon: 'ü§ñ',
    color: 'blue',
    examples: {
      challenge: [
        'Support client d√©bord√© par des tickets r√©p√©titifs',
        'Saisie manuelle de donn√©es chronophage',
        'Traitement de factures en masse',
        'R√©ponses automatiques aux demandes courantes'
      ],
      solutions: [
        'Chatbot IA pour les FAQ',
        'RPA pour la saisie de donn√©es',
        'OCR + IA pour lecture de documents',
        'Workflows automatis√©s'
      ],
      benefits: [
        'R√©duction de 60-80% du temps de traitement',
        'Diminution des erreurs humaines',
        'Lib√©ration des √©quipes pour des t√¢ches √† valeur ajout√©e',
        'Disponibilit√© 24h/24'
      ]
    },
    dafConcerns: [
      'Quel est le co√ªt total (licence + formation + maintenance) ?',
      'Combien de temps pour atteindre le retour sur investissement ?',
      'Quels sont les risques en cas de panne ou dysfonctionnement ?',
      'L\'√©quipe va-t-elle accepter cette automatisation ?'
    ],
    typicalROI: [
      '√âconomie de 30-50% sur les co√ªts de traitement',
      'ROI positif en 12-18 mois',
      'R√©duction de 40-60% des erreurs'
    ]
  },
  {
    id: 'reporting',
    name: 'Reporting & Business Intelligence',
    description: 'Automatiser et am√©liorer les reportings financiers',
    icon: 'üìä',
    color: 'purple',
    examples: {
      challenge: [
        'Reportings Excel manuels chronophages',
        'Donn√©es √©parpill√©es dans plusieurs syst√®mes',
        'Pas de vision temps r√©el de la performance',
        'Erreurs fr√©quentes dans les calculs'
      ],
      solutions: [
        'Tableaux de bord Power BI automatis√©s',
        'Connexions API vers les sources de donn√©es',
        'Dashboards temps r√©el',
        'Alertes automatiques sur les KPI'
      ],
      benefits: [
        'R√©duction de 70% du temps de cr√©ation des reportings',
        'Vision temps r√©el des indicateurs',
        'Fiabilit√© accrue des donn√©es',
        'Aide √† la d√©cision renforc√©e'
      ]
    },
    dafConcerns: [
      'Comment garantir la fiabilit√© et la s√©curit√© des donn√©es ?',
      'Quel budget pour les licences et la formation des √©quipes ?',
      'Qui sera responsable de la maintenance et des √©volutions ?',
      'Comment s\'assurer de l\'adoption par la direction ?'
    ],
    typicalROI: [
      'Gain de 15-20 jours/mois sur la production de reportings',
      'ROI positif en 8-12 mois',
      'Am√©lioration de 50% de la r√©activit√© d√©cisionnelle'
    ]
  },
  {
    id: 'collaboration',
    name: 'Collaboration & Communication',
    description: 'Am√©liorer la collaboration interne et l\'acc√®s √† l\'information',
    icon: 'üë•',
    color: 'green',
    examples: {
      challenge: [
        'Information √©parpill√©e entre emails et fichiers',
        '√âquipes distantes d√©connect√©es',
        'Onboarding laborieux des nouveaux',
        'Recherche d\'information chronophage'
      ],
      solutions: [
        'Intranet moderne avec moteur de recherche',
        'Portail collaboratif unifi√©',
        'Workflows de validation digitalis√©s',
        'Base de connaissance centralis√©e'
      ],
      benefits: [
        'R√©duction de 50% du temps de recherche d\'information',
        'Am√©lioration de l\'engagement des √©quipes',
        'Acc√©l√©ration de l\'onboarding',
        'Meilleure coh√©sion d\'√©quipe'
      ]
    },
    dafConcerns: [
      'Quel sera le taux d\'adoption par les √©quipes ?',
      'Comment mesurer concr√®tement les gains de productivit√© ?',
      'Quels co√ªts de conduite du changement pr√©voir ?',
      'Comment s\'assurer de la s√©curit√© des donn√©es partag√©es ?'
    ],
    typicalROI: [
      '√âconomie de 30min/jour/employ√© en recherche d\'info',
      'R√©duction de 40% du temps d\'onboarding',
      'ROI difficile √† quantifier mais impact organisationnel fort'
    ]
  },
  {
    id: 'financial',
    name: 'Gestion financi√®re & Comptable',
    description: 'Optimiser les processus financiers et comptables',
    icon: 'üí∞',
    color: 'orange',
    examples: {
      challenge: [
        'Gestion de tr√©sorerie manuelle et approximative',
        'Collecte de factures fournisseurs chronophage',
        'Manque de visibilit√© sur la rentabilit√©',
        'Pr√©paration √† la facturation √©lectronique'
      ],
      solutions: [
        'Plateforme de gestion financi√®re int√©gr√©e',
        'Automatisation des relances clients',
        'Tableaux de bord de tr√©sorerie temps r√©el',
        'Workflows de validation digitalis√©s'
      ],
      benefits: [
        'R√©duction de 50% du temps de cl√¥ture mensuelle',
        'Am√©lioration du BFR de 10-15%',
        'Vision temps r√©el de la tr√©sorerie',
        'Conformit√© r√©glementaire renforc√©e'
      ]
    },
    dafConcerns: [
      'Comment s\'assurer de la conformit√© avec l\'expert-comptable ?',
      'Quels co√ªts de migration des donn√©es historiques ?',
      'Comment former les √©quipes aux nouveaux processus ?',
      'Quel accompagnement pour la facturation √©lectronique ?'
    ],
    typicalROI: [
      '√âconomie de 3-5 jours/mois sur les cl√¥tures',
      'Am√©lioration du BFR √©quivalent √† 10-20K‚Ç¨ de tr√©sorerie',
      'ROI positif en 6-12 mois'
    ]
  },
  {
    id: 'hr-payroll',
    name: 'RH & Paie',
    description: 'Digitaliser et automatiser la gestion RH et paie',
    icon: 'üë®‚Äçüíº',
    color: 'pink',
    examples: {
      challenge: [
        'Collecte manuelle des variables de paie',
        'Gestion papier des cong√©s et absences',
        'Erreurs fr√©quentes sur les bulletins',
        'Pas d\'autonomie pour les employ√©s'
      ],
      solutions: [
        'Plateforme RH tout-en-un avec self-service',
        'Application mobile pour les √©quipes terrain',
        'Workflows automatis√©s de validation',
        'Connexion directe avec l\'expert paie'
      ],
      benefits: [
        'R√©duction de 90% du temps de pr√©paration de paie',
        '√âlimination des erreurs de saisie',
        'Autonomie des employ√©s pour leurs documents',
        'Am√©lioration de l\'exp√©rience collaborateur'
      ]
    },
    dafConcerns: [
      'Comment g√©rer la transition avec le prestataire paie actuel ?',
      'Quels co√ªts de formation et de conduite du changement ?',
      'Comment s\'assurer de la conformit√© URSSAF ?',
      'L\'√©quipe terrain va-t-elle adopter l\'outil mobile ?'
    ],
    typicalROI: [
      '√âconomie de 300-500‚Ç¨/mois sur la gestion administrative',
      'R√©duction de 80% des r√©clamations paie',
      'ROI positif en 8-15 mois selon la taille'
    ]
  },
  {
    id: 'data-analytics',
    name: 'Data & Analytics',
    description: 'Exploiter les donn√©es pour la prise de d√©cision',
    icon: 'üìà',
    color: 'indigo',
    examples: {
      challenge: [
        'Donn√©es silot√©es dans diff√©rents syst√®mes',
        'Pas d\'analyse pr√©dictive possible',
        'D√©cisions bas√©es sur l\'intuition',
        'KPIs calcul√©s manuellement'
      ],
      solutions: [
        'Data Lake centralis√© avec connecteurs',
        'Outils de Data Science et Machine Learning',
        'Dashboards pr√©dictifs automatis√©s',
        'Alerts automatiques sur anomalies'
      ],
      benefits: [
        'Vision 360¬∞ de l\'activit√© en temps r√©el',
        'Capacit√© de pr√©diction et d\'anticipation',
        'Optimisation des performances op√©rationnelles',
        'D√©tection pr√©coce des risques'
      ]
    },
    dafConcerns: [
      'Quelles comp√©tences internes d√©velopper ?',
      'Comment quantifier le ROI d\'un projet data ?',
      'Quels investissements en infrastructure pr√©voir ?',
      'Comment s\'assurer de la qualit√© des donn√©es ?'
    ],
    typicalROI: [
      'Am√©lioration de 15-25% de l\'efficacit√© op√©rationnelle',
      'R√©duction de 30% des risques non d√©tect√©s',
      'ROI variable selon le niveau de maturit√© data'
    ]
  }
];

export interface CaseBuildingStep {
  id: number;
  title: string;
  description: string;
  fields: FormField[];
}

export interface FormField {
  id: string;
  label: string;
  type: 'text' | 'textarea' | 'select' | 'multiselect' | 'number';
  placeholder?: string;
  options?: string[];
  required: boolean;
  helpText?: string;
}

export const CASE_BUILDING_STEPS: CaseBuildingStep[] = [
  {
    id: 1,
    title: 'Contexte & D√©fi',
    description: 'D√©crivez la situation actuelle et le probl√®me √† r√©soudre',
    fields: [
      {
        id: 'title',
        label: 'Titre du cas',
        type: 'text',
        placeholder: 'Ex: Automatisation du support client chez TechStart',
        required: true,
        helpText: 'Un titre accrocheur qui r√©sume votre cas'
      },
      {
        id: 'category',
        label: 'Cat√©gorie',
        type: 'select',
        options: CASE_TEMPLATES.map(t => t.name),
        required: true,
        helpText: 'Choisissez la cat√©gorie qui correspond le mieux'
      },
      {
        id: 'context',
        label: 'Contexte de l\'entreprise',
        type: 'textarea',
        placeholder: 'Ex: PME de 45 employ√©s dans la restauration rapide avec 4 points de vente...',
        required: true,
        helpText: 'D√©crivez l\'entreprise : taille, secteur, organisation actuelle'
      },
      {
        id: 'problem',
        label: 'Probl√®me principal',
        type: 'textarea',
        placeholder: 'Ex: La gestion manuelle des horaires variables g√©n√®re des erreurs de paie r√©currentes...',
        required: true,
        helpText: 'Quel est le probl√®me concret que vous voulez r√©soudre ?'
      },
      {
        id: 'impact',
        label: 'Impact du probl√®me',
        type: 'textarea',
        placeholder: 'Ex: 5h/semaine perdues, r√©clamations clients, stress des √©quipes...',
        required: true,
        helpText: 'Quelles sont les cons√©quences n√©gatives actuelles ?'
      }
    ]
  },
  {
    id: 2,
    title: 'Solution propos√©e',
    description: 'D√©taillez votre approche et les outils envisag√©s',
    fields: [
      {
        id: 'approach',
        label: 'Approche g√©n√©rale',
        type: 'textarea',
        placeholder: 'Ex: Impl√©menter une solution SaaS de gestion RH avec application mobile...',
        required: true,
        helpText: 'Comment comptez-vous r√©soudre le probl√®me ?'
      },
      {
        id: 'tools',
        label: 'Outils/Technologies',
        type: 'multiselect',
        options: ['SaaS', 'Application mobile', 'IA/Machine Learning', 'RPA', 'API/Int√©grations', 'Cloud', 'Power BI', 'ERP', 'CRM', 'Workflows', 'Autre'],
        required: true,
        helpText: 'Quels types d\'outils allez-vous utiliser ?'
      },
      {
        id: 'implementation',
        label: 'Plan de mise en ≈ìuvre',
        type: 'textarea',
        placeholder: 'Ex: Phase 1: Formation √©quipes (2 semaines), Phase 2: Migration donn√©es (1 mois)...',
        required: true,
        helpText: 'Comment planifiez-vous le d√©ploiement ?'
      }
    ]
  },
  {
    id: 3,
    title: 'R√©sultats attendus',
    description: 'Quantifiez les b√©n√©fices et le ROI de votre solution',
    fields: [
      {
        id: 'measurableROI',
        label: 'ROI mesurable',
        type: 'textarea',
        placeholder: 'Ex: √âconomie de 300‚Ç¨/mois, ROI positif en 12 mois, r√©duction de 50% des erreurs...',
        required: true,
        helpText: 'Donnez des chiffres concrets et v√©rifiables'
      },
      {
        id: 'timeGains',
        label: 'Gains de temps',
        type: 'textarea',
        placeholder: 'Ex: 5h/semaine √©conomis√©es, r√©duction de 70% du temps de traitement...',
        required: true,
        helpText: 'Quantifiez les gains de temps pour les √©quipes'
      },
      {
        id: 'otherBenefits',
        label: 'Autres b√©n√©fices',
        type: 'multiselect',
        options: ['Am√©lioration qualit√©', 'Satisfaction client', 'Motivation √©quipes', 'Conformit√© r√©glementaire', 'S√©curit√© des donn√©es', '√âvolutivit√©', 'Autre'],
        required: false,
        helpText: 'Quels autres avantages apporte votre solution ?'
      }
    ]
  },
  {
    id: 4,
    title: 'Perspective DAF',
    description: 'Anticipez les questions et pr√©occupations du DAF',
    fields: [
      {
        id: 'concerns',
        label: 'Pr√©occupations du DAF',
        type: 'multiselect',
        options: [
          'Co√ªt total de possession',
          'Temps de retour sur investissement',
          'Risques de s√©curit√©',
          'R√©sistance au changement',
          'Formation des √©quipes',
          'Fiabilit√© de la solution',
          'Conformit√© r√©glementaire',
          'Maintenance et support',
          '√âvolutivit√©',
          'D√©pendance fournisseur'
        ],
        required: true,
        helpText: 'Quelles seront les principales inqui√©tudes du DAF ?'
      },
      {
        id: 'questions',
        label: 'Questions types du DAF',
        type: 'textarea',
        placeholder: 'Ex: "Quel est le co√ªt de formation ?", "Que se passe-t-il si le fournisseur fait faillite ?"...',
        required: true,
        helpText: 'Listez 3-5 questions que le DAF pourrait poser'
      }
    ]
  }
];

export const getTemplateByCategory = (category: CaseCategory): CaseTemplate | undefined => {
  return CASE_TEMPLATES.find(template => template.id === category);
};

export const validateCase = (caseData: Partial<StudentCase>): { isValid: boolean; errors: string[] } => {
  const errors: string[] = [];

  if (!caseData.title?.trim()) {
    errors.push('Le titre est obligatoire');
  }

  if (!caseData.category) {
    errors.push('La cat√©gorie est obligatoire');
  }

  if (!caseData.challenge?.context?.trim()) {
    errors.push('Le contexte de l\'entreprise est obligatoire');
  }

  if (!caseData.challenge?.problem?.trim()) {
    errors.push('La description du probl√®me est obligatoire');
  }

  if (!caseData.solution?.approach?.trim()) {
    errors.push('L\'approche de solution est obligatoire');
  }

  if (!caseData.results?.measurableROI?.trim()) {
    errors.push('Le ROI mesurable est obligatoire');
  }

  return {
    isValid: errors.length === 0,
    errors
  };
};

export const generateCaseId = (): string => {
  return `case_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
};

export const saveCaseToLocalStorage = (studentCase: StudentCase): void => {
  try {
    const existingCases = getCasesFromLocalStorage();
    const updatedCases = [...existingCases, studentCase];
    localStorage.setItem('daf_student_cases', JSON.stringify(updatedCases));
  } catch (error) {
    console.error('Erreur lors de la sauvegarde du cas:', error);
  }
};

export const getCasesFromLocalStorage = (): StudentCase[] => {
  try {
    const cases = localStorage.getItem('daf_student_cases');
    return cases ? JSON.parse(cases) : [];
  } catch (error) {
    console.error('Erreur lors de la r√©cup√©ration des cas:', error);
    return [];
  }
};

export const deleteCaseFromLocalStorage = (caseId: string): void => {
  try {
    const existingCases = getCasesFromLocalStorage();
    const updatedCases = existingCases.filter(c => c.id !== caseId);
    localStorage.setItem('daf_student_cases', JSON.stringify(updatedCases));
  } catch (error) {
    console.error('Erreur lors de la suppression du cas:', error);
  }
};